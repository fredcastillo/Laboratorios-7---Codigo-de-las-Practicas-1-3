
# ===========================================
# PRACTICA 1 ‚Äì NETWORK FILE SYSTEM (NFS)
# ===========================================

sudo dnf install nfs-utils -y
sudo systemctl enable --now nfs-server
sudo systemctl start nfs-server
sudo systemctl status nfs-server
sudo mkdir -p /home/fred/OS3
cd /home/fred/OS3
sudo touch adrian{001..100}.txt
sudo chown -R nobody:nobody /home/fred/OS3
sudo chmod 777 /home/fred/OS3
nano /etc/exports
/home/fred/OS3 192.168.100.169(rw,sync,no_root_squash,no_subtree_check)
sudo exportfs -rav
sudo firewall-cmd --permanent --add-service=nfs
sudo firewall-cmd --permanent --add-service=mountd
sudo firewall-cmd --permanent --add-service=rpc-bind
sudo firewall-cmd --reload

# CLIENTE NFS
sudo dnf install nfs-utils -y
sudo mkdir -p /mnt/OS3
sudo mount -t nfs 192.168.100.168:/home/fred/OS3 /mnt/OS3
df -h
ls /mnt/OS3
sudo nano /etc/fstab
192.168.100.168:/home/fred/OS3 /mnt/OS3 nfs defaults 0 0
sudo reboot
df -h
ls /mnt/OS3

### ‚ùó NOTAS, ERRORES Y SOLUCIONES
- Error de montaje: verificar que nfs-server est√© activo y puerto abierto en firewall.
- Problema de permisos: revisar propiedad y permisos de la carpeta compartida.
- No se listan archivos: ejecutar sudo exportfs -rav en el servidor.
- Error de red: comprobar IP correcta y conectividad entre cliente y servidor.

### üìò T√âRMINOS IMPORTANTES
- **NFS**: Protocolo para compartir sistemas de archivos en red.
- **Export**: Carpeta compartida en NFS.
- **Mount**: Montar carpeta remota en el cliente.
- **no_root_squash**: Permite que root en cliente act√∫e como root en servidor.
- **sync**: Garantiza escritura inmediata en disco.
- **subtree_check**: Verifica cambios en subdirectorios.

# ===========================================
# PRACTICA 2 ‚Äì FILESERVER COMPATIBLE CON WINDOWS UTILIZANDO SAMBA
# ===========================================

sudo dnf install -y samba samba-client
sudo systemctl enable --now smb nmb
sudo systemctl start smb nmb
sudo systemctl status smb nmb
sudo mkdir -p /srv/samba/compartido
sudo chmod -R 777 /srv/samba/compartido
sudo touch /srv/samba/compartido/adrian{1..100}.txt
sudo nano /etc/samba/smb.conf
[compartido]
path = /srv/samba/compartido
browseable = yes
read only = no
writable = yes
guest ok = yes
sudo testparm
sudo systemctl restart smb nmb
sudo firewall-cmd --permanent --add-service=samba
sudo firewall-cmd --reload
sudo useradd fredsamba
sudo passwd fredsamba
sudo smbpasswd -a fredsamba
sudo smbpasswd -e fredsamba
sudo dnf install -y cifs-utils
sudo mount -t cifs //IP_DEL_SERVER/compartido /mnt -o guest
sudo semanage fcontext -a -t samba_share_t "/srv/samba/compartido(/.*)?"
sudo restorecon -R -v /srv/samba/compartido
sudo systemctl restart smb nmb
sudo smbclient -L localhost -U%
sudo journalctl -u smb -u nmb -f
sudo systemctl restart smb nmb

### ‚ùó NOTAS, ERRORES Y SOLUCIONES
- Error de SELinux: aplicar semanage y restorecon.
- Problemas de conexi√≥n: verificar firewall y servicios smb/nmb activos.
- Usuario Samba no funciona: revisar contrase√±a y agregar con smbpasswd.
- Montaje en Linux falla: comprobar IP y opciones de montaje cifs.

### üìò T√âRMINOS IMPORTANTES
- **Samba**: Servicio para compartir archivos entre Linux y Windows.
- **smb.conf**: Archivo de configuraci√≥n de Samba.
- **Guest**: Acceso sin autenticaci√≥n.
- **smbclient**: Herramienta para probar compartidos Samba.
- **SELinux**: Seguridad en Linux que puede bloquear accesos.
- **nmb**: Servicio para resoluci√≥n de nombres NetBIOS.

# ===========================================
# PRACTICA 3 ‚Äì CREACION DE CONTROLADOR DE DOMINIO COMPATIBLE CON CLIENTE WINDOWS UTILIZANDO SAMBA
# ===========================================

sudo hostnamectl set-hostname dc1.os3.inet
sudo nano /etc/hosts
192.168.100.168 dc1.os3.inet dc1
sudo dnf -y update
sudo dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm -y
sudo crb enable
sudo dnf makecache
sudo dnf install -y wget tar gcc make python3-devel flex bison gdb git keyutils-libs-devel libacl-devel libattr-devel libblkid-devel libxml2-devel libxslt-devel openldap-devel pam-devel popt-devel readline-devel zlib-devel systemd-devel lmdb-devel jansson-devel gpgme-devel libarchive-devel libicu-devel perl-ExtUtils-MakeMaker perl-Parse-Yapp rpcgen libtirpc-devel gnutls-devel python3-cryptography python3-dns python3-markdown python3-dnspython python3-pip
sudo pip3 install markdown python3
sudo mkdir -p /samba
cd /samba
sudo wget https://download.samba.org/pub/samba/stable/samba-4.21.1.tar.gz
sudo tar -zxvf samba-4.21.1.tar.gz
cd samba-4.21.1/
sudo dnf install dbus-devel -y
sudo ./configure --prefix=/usr/local/samba --enable-fhs --with-systemd --with-ads --with-ldap
sudo make
sudo make install
export PATH=/usr/local/samba/bin:/usr/local/samba/sbin:$PATH
echo 'export PATH=$PATH:/usr/local/samba/bin:/usr/local/samba/sbin' >> ~/.bashrc
source ~/.bashrc
sudo /usr/local/samba/bin/samba-tool domain provision --use-rfc2307 --interactive --option="interfaces= lo ens33" --option="bind interfaces only=yes"
sudo cp /usr/local/samba/var/lib/samba/private/krb5.conf /etc/krb5.conf
sudo nano /etc/systemd/system/samba-ad-dc.service
# Contenido modificado seg√∫n instrucciones
sudo systemctl daemon-reload
sudo systemctl enable --now samba-ad-dc
sudo firewall-cmd --permanent --add-service={dns,kerberos,ldap,ldaps}
sudo firewall-cmd --permanent --add-port={53,88,135,139,389,445,464,636,3268,3269}/tcp
sudo firewall-cmd --permanent --add-port={53,88,137,138,389,464}/udp
sudo firewall-cmd --reload
sudo /usr/local/samba/bin/samba-tool user add lanegracubana 20252175Fc
host -t SRV _ldap._tcp.os3.inet
sudo dnf install krb5-workstation -y
kinit administrator

### ‚ùó NOTAS, ERRORES Y SOLUCIONES
- Error de resoluci√≥n DNS: verificar /etc/resolv.conf y firewall.
- Cliente Windows no se une al dominio: comprobar DNS apuntando al controlador Samba.
- Problemas de Kerberos: asegurar que krb5.conf est√© correctamente copiado.
- Servicio Samba no inicia: verificar archivo systemd y permisos.
- Fallos en provisi√≥n del dominio: asegurarse de dependencias y variables PATH.

### üìò T√âRMINOS IMPORTANTES
- **Controlador de Dominio (DC)**: Servidor que gestiona usuarios y permisos de dominio.
- **Samba-tool**: Herramienta para administrar Samba y dominios.
- **Kerberos**: Protocolo de autenticaci√≥n en red.
- **Realm**: Nombre del dominio en Samba/AD.
- **DNS interno**: Resuelve nombres del dominio local.
- **Provisioning**: Configuraci√≥n inicial de un DC Samba.

--------------------

PRACTICA 1 ‚Äì NFS

sudo dnf install nfs-utils -y


sudo systemctl enable --now nfs-server 
sudo systemctl start nfs-server
sudo systemctl status nfs-server


sudo mkdir -p /home/fred/OS3
cd  /home/fred/OS3
sudo touch adrian{001..100}.txt

sudo chown -R nobody:nobody /home/fred/OS3
sudo chmod 777 /home/fred/OS3


nano /etc/exports

--------dentro del nano-------

/home/fred/OS3 192.168.100.169(rw,sync,no_root_squash,no_subtree_check)

------------------------------
mnt
sudo exportfs -rav

sudo firewall-cmd --permanent --add-service=nfs
sudo firewall-cmd --permanent --add-service=mountd
sudo firewall-cmd --permanent --add-service=rpc-bind
sudo firewall-cmd --reload

-----CLIENTE NFS-----

sudo dnf install nfs-utils -y

sudo mkdir -p /mnt/OS3
sudo mount -t nfs 192.168.100.168:/home/fred/OS3 /mnt/OS3
df -h
ls /mnt/OS3	

#para el montaje permanente

sudo nano /etc/fstab

--------dentro del nano-------

192.168.100.168:/home/fred/OS3 /mnt/OS3 nfs defaults 0 0

------------------------------

sudo reboot

df -h
ls /mnt/OS3

============================================

PRACTICA 2 ‚Äì FILESERVER COMPATIBLE CON WINDOWS UTILIZANDO SAMBA (CentOS Stream 10)

#1 Instalar Samba
sudo dnf install -y samba samba-client

#2 Habilitar servicios Samba
sudo systemctl enable --now smb nmb
sudo systemctl start smb nmb
sudo systemctl status smb nmb

#3 Crear carpeta compartida
sudo mkdir -p /srv/samba/compartido

#4 Asignar permisos
sudo chmod -R 777 /srv/samba/compartido
# (Opcional)
# sudo chown -R nobody:nobody /srv/samba/compartido

#5 Crear 100 archivos adrian1‚Ä¶adrian100
sudo touch /srv/samba/compartido/adrian{1..100}.txt

#6 Editar archivo de configuraci√≥n de Samba
sudo nano /etc/samba/smb.conf

# Agregar al final del archivo:
[compartido]
    path = /srv/samba/compartido
    browseable = yes
    read only = no
    writable = yes
    guest ok = yes

#7 Probar sintaxis del archivo smb.conf
sudo testparm

#8 Reiniciar servicios Samba
sudo systemctl restart smb nmb

#9 Configurar firewall para permitir Samba
sudo firewall-cmd --permanent --add-service=samba
sudo firewall-cmd --reload

#10 (Opcional) Crear usuario Samba
sudo useradd fredsamba
sudo passwd fredsamba
sudo smbpasswd -a fredsamba
sudo smbpasswd -e fredsamba

#11 Conectarse desde Linux (cliente)
sudo dnf install -y cifs-utils
sudo mount -t cifs //IP_DEL_SERVER/compartido /mnt -o guest
# Con usuario:
# sudo mount -t cifs //IP_DEL_SERVER/compartido /mnt -o username=usuario1

------------------
ERROR CON SELINUX SOLUCIONADO

PASOS 

sudo semanage fcontext -a -t samba_share_t "/srv/samba/compartido(/.*)?"
Asigna la etiqueta de seguridad samba_share_t a la ruta.

sudo restorecon -R -v /srv/samba/compartido
Aplica la etiqueta inmediatamente, eliminando el bloqueo.

sudo systemctl restart smb nmb

--------------

#12 Conectarse desde Windows
# Abrir Explorador de archivos
# Escribir en la barra: \\192.168.100.168\compartido
FREDSERVER\fredsamba o fredsamba
# Ver los 100 archivos Adrian1‚Ä¶Adrian100

#13 Desde Windows: abrir Adrian99.txt
# Escribir: el zumzum de la carabela
# Guardar

#14 Validar desde Linux que el archivo fue modificado
cat /srv/samba/compartido/adrian99.txt

#15 Ver logs en tiempo real (por si hay fallos)
sudo journalctl -u smb -u nmb -f

#16 Reiniciar Samba si es necesario
sudo systemctl restart smb nmb

#17 Ver compartidos Samba locales
sudo smbclient -L localhost -U%


============================================

PRACTICA 3 ‚Äì CREACION DE CONTROLADOR DE DOMINIO COMPATIBLE CON CLIENTE WINDOWS UTILIZANDO SAMBA (CentOS Stream 10)

# 1. Configurar Hostname
sudo hostnamectl set-hostname dc1.os3.inet
sudo nano /etc/hosts
192.168.100.168   dc1.os3.inet   dc1

# 3. Actualizar
sudo dnf -y update

# 4. Habilitar Repositorio EPEL 10
sudo dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm -y

# 5. Habilitar CodeReady Builder (CRB)
sudo crb enable

# 6. Refrescar cach√©
sudo dnf makecache

## Instalaci√≥n de Dependencias ##

# Herramientas b√°sicas de compilaci√≥n
sudo dnf install -y wget tar gcc make python3-devel \
    flex bison gdb git keyutils-libs-devel \
    libacl-devel libattr-devel libblkid-devel \
    libxml2-devel libxslt-devel \
    openldap-devel pam-devel popt-devel \
    readline-devel zlib-devel systemd-devel \
    lmdb-devel jansson-devel gpgme-devel \
    libarchive-devel libicu-devel \
    perl-ExtUtils-MakeMaker perl-Parse-Yapp \
    rpcgen libtirpc-devel
    
# Instalar librer√≠as de criptograf√≠a y seguridad
sudo dnf install -y gnutls-devel python3-cryptography python3-dns


## Descarga y Compilaci√≥n de Samba ##

# 1. Crear directorio y descargar
sudo mkdir -p /samba
cd /samba
sudo wget https://download.samba.org/pub/samba/stable/samba-4.21.1.tar.gz

# 2. Descomprimir
sudo tar -zxvf samba-4.21.1.tar.gz
cd samba-4.21.1/

# 3. Configurar la compilaci√≥n
sudo dnf install dbus-devel -y
sudo dnf install -y \
    python3-markdown \
    python3-dnspython \
    python3-devel \
    dbus-devel \
    libacl-devel \
    libattr-devel \
    libblkid-devel \
    gnutls-devel \
    openldap-devel \
    pam-devel \
    popt-devel \
    readline-devel \
    libarchive-devel \
    cups-devel \
    libxml2-devel \
    libxslt-devel \
    zlib-devel \
    keyutils-libs-devel \
    libtirpc-devel \
    rpcgen \
    lmdb-devel \
    jansson-devel \
    gpgme-devel \
    perl-ExtUtils-MakeMaker \
    perl-Parse-Yapp \
    perl-Test-Simple \
    bison \
    flex \
    gcc \
    make

sudo dnf install python3-pip -y
sudo pip3 install markdown
python3 -c "import markdown"

# Verificar que se tiene todo lo necesario
sudo ./configure --prefix=/usr/local/samba --enable-fhs --with-systemd --with-ads --with-ldap

# Instalamos dependencias de perl 
sudo dnf install perl-Parse-Yapp perl-Test-Simple perl-ExtUtils-MakeMaker -y
sudo dnf install perl-FindBin perl-lib perl-English -y

# 4. Compilar
sudo make

# 5. Instalar
sudo make install

## Configuraci√≥n del Entorno (Para que la terminal reconozca los comandos samba y samba-tool) ##

# Agregar al PATH actual
export PATH=/usr/local/samba/bin:/usr/local/samba/sbin:$PATH

# Hacerlo permanente para tu usuario
echo 'export PATH=$PATH:/usr/local/samba/bin:/usr/local/samba/sbin' >> ~/.bashrc
source ~/.bashrc

## Aprovisionamiento del Dominio ##

sudo /usr/local/samba/bin/samba-tool domain provision \
 --use-rfc2307 \
 --interactive \
 --option="interfaces= lo ens33" \
 --option="bind interfaces only=yes"
 
Realm: OS3.inet
Domain: OS3-DOM
Server Role: dc
DNS backend: SAMBA_INTERNAL
DNS Forwarder IP address: 192.168.100.1
Administrator password: 20252175Fc

## Editamos el archivo de resoluci√≥n DNS ##
sudo nano /etc/resolv.conf
nameserver 127.0.0.1
nameserver 8.8.8.8

## Configuraci√≥n de Kerberos y Arranque ##

# 1. Copiar configuraci√≥n de Kerberos

sudo cp /usr/local/samba/var/lib/samba/private/krb5.conf /etc/krb5.conf

# 2. Crear el servicio de Systemd (Para que inicie como servicio)
# Como compilamos, no se cre√≥ el servicio autom√°tico. Vamos a crearlo:
sudo nano /etc/systemd/system/samba-ad-dc.service

[Unit]
Description=Samba Active Directory Domain Controller
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/usr/local/samba/sbin/samba -D
PIDFile=/usr/local/samba/var/run/samba.pid
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target

## Inicializaci√≥n del servicio ##

Hacemos unos cambios en el archivo antes de iniciarlo:

sudo setenforce 0
sudo nano /etc/systemd/system/samba-ad-dc.service
Cambiar Type fork por Type simple
Cambiar ExecStart=.../samba -D a ExecStart=.../samba -i
Borrar PID File

sudo systemctl daemon-reload
sudo systemctl enable --now samba-ad-dc

## Configuraci√≥n del Firewall ##

sudo firewall-cmd --permanent --add-service={dns,kerberos,ldap,ldaps}
sudo firewall-cmd --permanent --add-port={53,88,135,139,389,445,464,636,3268,3269}/tcp
sudo firewall-cmd --permanent --add-port={53,88,137,138,389,464}/udp
sudo firewall-cmd --reload

## Agregamos usuario ##

sudo /usr/local/samba/bin/samba-tool user add lanegracubana 20252175Fc

## Pruebas en Linux ##

# Verificar DNS
host -t SRV _ldap._tcp.os3.inet

# Verificar Autenticaci√≥n
sudo dnf install krb5-workstation -y
kinit administrator
# (Poner la contrase√±a)

## En windows ##

(EN CASO DE ERROR, CONSIDERE DESACTIVAR EL FIREWALL DE LINUX)

Propiedades IPv4 y en servidor DNS preferido ponemos la ip de nuestra maquina

win + r ncpa.cpl
VAMOS A PROPIEDADES
apagamos ipv6
en DNS escojemos la ultima opci√≥n y pondremos la ip del servidor Linux (192.168.100.168)

probamos la conexi√≥n con ping os3.inet

win + r sysdm.cpl

Poner en miembro del dominio
Dominio: os3.inet
Usuario: Administrator
Clave: 20252175Fc
Reiniciamos y entramos







